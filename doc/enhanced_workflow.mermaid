flowchart TB
 subgraph P1["Phase 1: Land Selection & Input Preparation"]
        B["Select Target Parcels<br>~500-1000 Ha"]
        A["Technical Team:<br>Land Suitability Analysis"]
        C["Create Input Excel<br>7 Required Fields"]
        D{"Sezione<br>Required?"}
        E["Land Manager:<br>Check SISTER Portal"]
        F["Launch Campaign"]
  end
 subgraph P2["Phase 2: Automated Pipeline Processing v2.9"]
        G["campaign_launcher.py<br>Initialize Campaign"]
        H["land_acquisition_pipeline.py<br>Process Municipalities"]
        I["Catasto API:<br>Get Property Owners"]
        J["Parse Owner Data<br>Extract All Properties"]
        T1["Save Request ID<br>for Recovery"]
        K{"Owner Type<br>Classification"}
        L["Filter Cat.A<br>Residential Only"]
        M["Company Processing"]
        N["Address Cleaning<br>Remove Floor/Apt Info"]
        O["PEC Email API<br>Get Certified Email"]
        P["Geocoding API<br>Enhance Addresses"]
        Q["Extract ZIP Code<br>+ 17 Fields"]
        T2["Save for Recovery"]
        R["Address Quality<br>Classification v2.9"]
        S["Companies_Found.xlsx"]
  end
 subgraph P3["Phase 3: Address Quality Intelligence v2.9"]
        U1{"SNC<br>Check"}
        V1["HIGH Confidence<br>â†’ DIRECT_MAIL"]
        U2{"Number<br>Match?"}
        V2["HIGH Confidence<br>â†’ DIRECT_MAIL"]
        V3["MEDIUM Confidence<br>â†’ DIRECT_MAIL<br>Use Original"]
        U3{"Geocoded<br>Number?"}
        V4["LOW: Interpolated<br>â†’ AGENCY"]
        V5["LOW: No Number<br>â†’ AGENCY"]
        W["Deduplication:<br>CF + Address"]
  end
 subgraph P4["Phase 4: Output & Funnel Analytics"]
        X["Generate Files<br>Track Funnel Metrics"]
        Y1["Validation_Ready.xlsx<br>Deduplicated Contacts"]
        Y2["Municipality_Summary<br>15+ Metrics + Funnel Data"]
        Y3["Raw_Data.xlsx<br>Complete Dataset"]
        Y4["Companies with PEC"]
        Z1["OneDrive Sync"]
        Z2["PowerBI_Dataset.csv<br>Campaign Analytics"]
  end
 subgraph P5["Phase 5: Multi-Channel Outreach"]
        AA["Land Team:<br>Review Addresses"]
        AB{"Route by<br>Channel"}
        AC["Print Service"]
        AD["Local Agencies<br>Manual Contact"]
        AE["PEC Outreach"]
        AF["Response Tracking"]
  end
    A --> B
    B --> C
    C --> D
    D -- Yes: Bologna, Valsamoggia --> E
    D -- No: Most municipalities --> F
    E --> F
    F --> G
    G --> H
    H --> I
    I -- Success --> J
    I -- Timeout --> T1
    J --> K
    K -- Privato<br>CF starts with letter --> L
    K -- Azienda<br>CF starts with digit --> M
    L --> N
    M --> O
    N --> P
    P -- Success --> Q
    P -- Timeout --> T2
    Q --> R
    O --> S
    R --> U1
    U1 -- Yes: Small street --> V1
    U1 -- No --> U2
    U2 -- "Original = Geocoded" --> V2
    U2 -- Original â‰  Geocoded --> V3
    U2 -- No Original Number --> U3
    U3 -- Yes --> V4
    U3 -- No --> V5
    V1 --> W
    V2 --> W
    V3 --> W
    V4 --> W
    V5 --> W
    W --> X
    X --> Y1 & Y2 & Y3
    S --> Y4
    Y1 --> Z1 & AA
    Y2 --> Z1
    Y3 --> Z1
    Y4 --> Z1 & AE
    Z1 --> Z2
    AA --> AB
    AB -- DIRECT_MAIL --> AC
    AB -- AGENCY --> AD
    AC --> AF
    AD --> AF
    AE --> AF
    T1 --> T3["Timeout Recovery<br>After Campaign"]
    T2 --> T3
    T3 -.-> J & Q
    H -.-> FM["Funnel Metrics:<br>â€¢ Input: X parcels, Y hectares<br>â€¢ After API: X1 parcels, Y1 ha<br>â€¢ Private: X2, Company: X3<br>â€¢ After Cat.A: X4 parcels, Y4 ha<br>â€¢ Final: X5 contacts"]
    Y2 -.-> M1["v2.9 Enhancements:<br>â€¢ SNC â†’ Direct Mail<br>â€¢ Full Funnel Visibility<br>â€¢ Company Integration"]
    Z2 ==> NP["ðŸŽ¯ NEXT: Single File<br>Output Structure"]

    style R fill:#4caf50,color:#fff
    style V1 fill:#FFFFFF
    style FM fill:#ffeb3b,color:#000
    style NP fill:#ffc107,color:#000
    style P1 fill:#e3f2fd
    style P2 fill:#f3e5f5
    style P3 fill:#e8f5e9
    style P4 fill:#fff3e0
    style P5 fill:#fce4ec


